<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>MPC Ball Balancing Robot | Julien Rineau</title>
<meta name="keywords" content="">
<meta name="description" content="Control a ball on a plate using a robotic manipulator and a MPC controller. This project was carried out as part of the CS206B Robotic Manipulation and Interaction course at UC Berkeley
MPC Controller MPC is a type of feedback control algorithm, in which a model of the system is used to make predictions about it&rsquo;s future behavior. The control inputs are then computed based on the predictions, with the goal of achieving the desired system behavior.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/ball-balancing-robot/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/ball-balancing-robot/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css"
    integrity="sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"
    integrity="sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd" crossorigin="anonymous">
</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"
    integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body, 
              {
                  delimiters: [
                      {left: '$$', right: '$$', display: true},
                      {left: '\\[', right: '\\]', display: true},
                      {left: '$', right: '$', display: false},
                      {left: '\\(', right: '\\)', display: false}
                  ]
              }
    );"></script>

</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Julien Rineau (Alt + H)">Julien Rineau</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      MPC Ball Balancing Robot
    </h1>
    <div class="post-meta"><span title='2023-03-25 00:00:00 +0000 UTC'>March 25, 2023</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#mpc-controller" aria-label="MPC Controller">MPC Controller</a></li>
                <li>
                    <a href="#ball-detection" aria-label="Ball Detection">Ball Detection</a></li>
                <li>
                    <a href="#ros-architechture" aria-label="ROS Architechture">ROS Architechture</a></li>
                <li>
                    <a href="#results" aria-label="Results">Results</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Control a ball on a plate using a robotic manipulator and a MPC controller. This project was carried out as part of the CS206B Robotic Manipulation and Interaction course at UC Berkeley</p>
<h2 id="mpc-controller">MPC Controller<a hidden class="anchor" aria-hidden="true" href="#mpc-controller">#</a></h2>
<p>MPC is a type of feedback control algorithm, in which a model of the system is used to make predictions about it&rsquo;s future behavior. The control inputs are then computed based on the predictions, with the goal of achieving the desired system behavior. This is done iteratively, with the model being updated at each time step based on the measured system outputs.</p>
<p><img loading="lazy" src="/img/mpc-ball-controller/mpc_logo.png" alt="MPC logo"  />
</p>
<p>The MPC design used is a Eulerian discretized model of general point-mass plate movement. The model does not take into account rolling ball dynamics, friction, or other external disturbances. While including this information may make the MPC more accurate in its predictions, feedback provided by monitoring the system would be able to correct for any major prediction error. A simplified version of the model’s provided states, system dynamics, and resulting output command are shown below.</p>
\[
\begin{bmatrix}
x \\
y \\
\dot{x} \\
\dot{y} \\
\theta \\
\psi \\
\end{bmatrix}
\quad \rightarrow \quad 
\begin{cases}
x_{k+1} = x_k + \dot{x}_k \Delta t \\
y_{k+1} = y_k + \dot{y}_k \Delta t \\
\dot{x}_{k+1} = \dot{x}_k - g \sin \theta_k \Delta t \\
\dot{y}_{k+1} = \dot{y}_k - g \sin \psi_k \cos \theta_k \Delta t \\
\theta_{k+1} = \theta_k + \dot{\theta}_k \Delta t \\
\psi_{k+1} = \psi_k + \dot{\psi}_k \Delta t
\end{cases}
\quad \rightarrow \quad 
\begin{bmatrix}
\dot{\theta} \\
\dot{\psi} \\
\end{bmatrix}
\]
<p>The MPC was tested against model-accurate and non-model accurate versions of a simulation environment. Even with cases such as 80% input, failing small-angle assumptions, or noisy position data, the MPC did a solid job at managing to reach desired positions and follow paths. A noisy simulation environment with reference tracking is shown below, with the red dot describing the desired position, grey dot as the simulated position of the ball, and the small markers indicating the MPC’s predicted future states.</p>
<p><img loading="lazy" src="/img/mpc-ball-controller/tracking_sim.gif" alt="MPC logo"  />
</p>
<h2 id="ball-detection">Ball Detection<a hidden class="anchor" aria-hidden="true" href="#ball-detection">#</a></h2>
<p>The ball detection has been kept as lightweight as possible to used in real time. The process involves thresholding to separate the ball from the background, applying Gaussian blur to smooth edges, adding erosion and dilation to refine object boundaries, detecting contours to identify the ball, and estimating its centroid position.</p>
<p><img loading="lazy" src="/img/mpc-ball-controller/cv_flow.png" alt="MPC logo"  />
</p>
<h2 id="ros-architechture">ROS Architechture<a hidden class="anchor" aria-hidden="true" href="#ros-architechture">#</a></h2>
<p>In a ROS-based system for controlling a robotic arm using ping pong ball coordinates, the architecture is structured into three modular ROS nodes:</p>
<ul>
<li><strong>Sensor Node:</strong> Detects the ping pong ball using cameras and publishes its coordinates.</li>
<li><strong>Control Node:</strong> Receives the ball coordinates, calculates the necessary control inputs for the robotic arm&rsquo;s position and orientation, and then publishes these inputs.</li>
<li><strong>Actuator Node:</strong> Receives control inputs and manipulates the robotic arm&rsquo;s motors to achieve the desired position and orientation.</li>
</ul>
<p>This setup enhances system flexibility and streamlines development, testing, and maintenance.</p>
<p><img loading="lazy" src="/img/mpc-ball-controller/code_architechture.png" alt="MPC logo"  />
</p>
<h2 id="results">Results<a hidden class="anchor" aria-hidden="true" href="#results">#</a></h2>
<p>The robot used is a Sawyer arm on which we attached a custom platform that hold the webcam and where the ball is balanced.</p>


    
    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="allowfullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/ubb5QVqX0ho?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"
      ></iframe>
    </div>



  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Julien Rineau</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
