<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>GPT-2 Pretraining with Lightning | Julien Rineau</title>
<meta name="keywords" content="">
<meta name="description" content="A nano-GPT implementation with Pytorch Lightning. The goal is to have a clean building block for other research projects by containing just enough manual implementation do be easily modifiable, but also by using common tools to have a painless optimized training and nice monitoring. Its contains the code to train the model, prepare the dataset and run evals. This page also details results I got training on HF&rsquo;s FineWeb-Edu.
Code Repository">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/gpt-lightning/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/gpt-lightning/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css"
    integrity="sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"
    integrity="sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd" crossorigin="anonymous">
</script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"
    integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body, 
              {
                  delimiters: [
                      {left: '$$', right: '$$', display: true},
                      {left: '\\[', right: '\\]', display: true},
                      {left: '$', right: '$', display: false},
                      {left: '\\(', right: '\\)', display: false}
                  ]
              }
    );"></script>

</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Julien Rineau (Alt + H)">Julien Rineau</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      GPT-2 Pretraining with Lightning
    </h1>
    <div class="post-meta"><span title='2023-11-12 00:00:00 +0000 UTC'>November 12, 2023</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#architechture" aria-label="Architechture">Architechture</a></li>
                <li>
                    <a href="#training" aria-label="Training">Training</a><ul>
                        
                <li>
                    <a href="#optimization-techniques-used" aria-label="Optimization Techniques Used">Optimization Techniques Used</a></li>
                <li>
                    <a href="#dataset" aria-label="Dataset">Dataset</a></li>
                <li>
                    <a href="#results" aria-label="Results">Results</a></li></ul>
                </li>
                <li>
                    <a href="#how-to-use-this-implementation" aria-label="How to Use This Implementation">How to Use This Implementation</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>A nano-GPT implementation with Pytorch Lightning. The goal is to have a clean building block for other research projects by containing just enough manual implementation do be easily modifiable, but also by using common tools to have a painless optimized training and nice monitoring. Its contains the code to train the model, prepare the dataset and run evals. This page also details results I got training on HF&rsquo;s FineWeb-Edu.</p>
<p><a href="https://github.com/JulienRineau/gpt2-workflow">Code Repository</a></p>
<h2 id="architechture">Architechture<a hidden class="anchor" aria-hidden="true" href="#architechture">#</a></h2>
<p><img alt="GPT architechture" src="/img/gpt-lightning/gpt2-architechture.png"></p>
<p>My implementation is identical to the small GPT2 model but without the dropout layers:</p>
<ul>
<li>50304 vocab size</li>
<li>768 embedding size</li>
<li>12 heads</li>
<li>12 transformer block</li>
</ul>
<p>This gives us a total of 124M params.
Its a causal model so next tokens are mask in the self-attention matrix.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>GPTLightning(
</span></span><span style="display:flex;"><span>  (model): GPT(
</span></span><span style="display:flex;"><span>    (transformer): ModuleDict(
</span></span><span style="display:flex;"><span>      (wte): Embedding(<span style="color:#ae81ff">50304</span>, <span style="color:#ae81ff">768</span>)
</span></span><span style="display:flex;"><span>      (wpe): Embedding(<span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">768</span>)
</span></span><span style="display:flex;"><span>      (h): ModuleList(
</span></span><span style="display:flex;"><span>        (<span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>): <span style="color:#ae81ff">12</span> x Block(
</span></span><span style="display:flex;"><span>          (ln_1): LayerNorm((<span style="color:#ae81ff">768</span>,), eps<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-05</span>, elementwise_affine<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>          (attn): CausalSelfAttention(
</span></span><span style="display:flex;"><span>            (c_attn): Linear(in_features<span style="color:#f92672">=</span><span style="color:#ae81ff">768</span>, out_features<span style="color:#f92672">=</span><span style="color:#ae81ff">2304</span>, bias<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            (c_proj): Linear(in_features<span style="color:#f92672">=</span><span style="color:#ae81ff">768</span>, out_features<span style="color:#f92672">=</span><span style="color:#ae81ff">768</span>, bias<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>          )
</span></span><span style="display:flex;"><span>          (ln_2): LayerNorm((<span style="color:#ae81ff">768</span>,), eps<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-05</span>, elementwise_affine<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>          (mlp): MLP(
</span></span><span style="display:flex;"><span>            (c_fc): Linear(in_features<span style="color:#f92672">=</span><span style="color:#ae81ff">768</span>, out_features<span style="color:#f92672">=</span><span style="color:#ae81ff">3072</span>, bias<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            (gelu): GELU(approximate<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;tanh&#39;</span>)
</span></span><span style="display:flex;"><span>            (c_proj): Linear(in_features<span style="color:#f92672">=</span><span style="color:#ae81ff">3072</span>, out_features<span style="color:#f92672">=</span><span style="color:#ae81ff">768</span>, bias<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>          )
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>      )
</span></span><span style="display:flex;"><span>      (ln_f): LayerNorm((<span style="color:#ae81ff">768</span>,), eps<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-05</span>, elementwise_affine<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    (lm_head): Linear(in_features<span style="color:#f92672">=</span><span style="color:#ae81ff">768</span>, out_features<span style="color:#f92672">=</span><span style="color:#ae81ff">50304</span>, bias<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h2 id="training">Training<a hidden class="anchor" aria-hidden="true" href="#training">#</a></h2>
<h3 id="optimization-techniques-used">Optimization Techniques Used<a hidden class="anchor" aria-hidden="true" href="#optimization-techniques-used">#</a></h3>
<p>This implementation incorporates several optimization techniques:</p>
<ul>
<li><strong>Scheduled Learning Rate</strong>: Warmup and cosine annealing like in the GPT-3 paper</li>
<li><strong>Mixed Precision</strong>: BF16 mixed precision to for computational efficiency and memory usage.</li>
<li><strong>Gradient Clipping</strong>: Set to 1.0 like in the GPT-3 paper.</li>
<li><strong>Weight Decay</strong>: Set to 0.3, I found that a bigger number than in the GPT-3 paper (0.1) work better in my case.</li>
<li><strong>DDP (Distributed Data Parallel)</strong>: Facilitates parallel data processing on multiple GPUs, accelerating training times significantly.</li>
</ul>
<h3 id="dataset">Dataset<a hidden class="anchor" aria-hidden="true" href="#dataset">#</a></h3>
<p>I used a A100 instance from Lambda Labs for the training. The training dataset was a 10B subset of the HF&rsquo;s FineWeb-Edu dataset which is about 3T of disk space. My instance had on 512B of storage the pipeline was built to streamed the dataset, but for better performances storing shard is better.</p>
<p>The dataset loader tokenize FineWeb-edu&rsquo;s docs, then process these tokens into fixed-size chunks based on a predefined sequence length. Each chunk is designed to include an extra token that helps create pairs of inputs and expected outputs. The input consists of a sequence of tokens, and the output is the same sequence shifted by one position.</p>
<h3 id="results">Results<a hidden class="anchor" aria-hidden="true" href="#results">#</a></h3>
<p>Given that I was renting my GPU I did not ran an hyperparemeter sweep but could ran some test on a smaller dataset. I constated that while Mixed Precision and DDP increased the speed, the Scheduled Learning Rate had the biggest impact on the loss.</p>
<p><img alt="GPT architechture" src="/img/gpt-lightning/training_loss_chart.png"></p>
<p>Whole training:
TBD..</p>
<h2 id="how-to-use-this-implementation">How to Use This Implementation<a hidden class="anchor" aria-hidden="true" href="#how-to-use-this-implementation">#</a></h2>
<p>For detailed instructions on how to use this implementation, refer to the <a href="https://github.com/JulienRineau/gpt2-workflow">GitHub repository</a>, which includes comprehensive documentation on setup, configuration, and execution.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Julien Rineau</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
